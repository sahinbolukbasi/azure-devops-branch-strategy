# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Business Central CI/CD Pipeline
# Branch Strategy: feature/* â†’ sandbox â†’ release â†’ main
# Environments: Sandbox (Dev/Test) | Production (CanlÄ±)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# BRANCH HÄ°YERARÅžÄ°SÄ°: 
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ main (Production)                                                           â”‚
# â”‚   â”œâ”€â”€ â† release (PR ile merge)                                              â”‚
# â”‚   â”œâ”€â”€ â† hotfix/* (Acil dÃ¼zeltmeler - main'den aÃ§Ä±lÄ±r, main'e merge olur)   â”‚
# â”‚   â”‚                                                                         â”‚
# â”‚ release (Pre-Production/UAT)                                                â”‚
# â”‚   â”œâ”€â”€ â† sandbox (PR ile merge)                                              â”‚
# â”‚   â”œâ”€â”€ â† bugfix/* (Release dÃ¼zeltmeleri - release'den aÃ§Ä±lÄ±r)               â”‚
# â”‚   â”‚                                                                         â”‚
# â”‚ sandbox (Development/Test)                                                  â”‚
# â”‚   â”œâ”€â”€ â† feature/* (Yeni Ã¶zellikler - sandbox'dan aÃ§Ä±lÄ±r)                   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# AKIÅž: 
# 1. Yeni Ã¶zellik:  sandbox â†’ feature/* â†’ sandbox â†’ release â†’ main
# 2. Release fix:   release â†’ bugfix/* â†’ release â†’ main (sonra back-merge)
# 3. Hotfix:        main â†’ hotfix/* â†’ main (sonra back-merge: mainâ†’releaseâ†’sandbox)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

trigger:
  branches: 
    include: 
      - main
      - release
      - sandbox
      - feature/*
      - bugfix/*
      - hotfix/*

pr:
  branches: 
    include: 
      - main
      - release
      - sandbox

variables:
  # Branch Detection
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  isRelease: $[eq(variables['Build.SourceBranch'], 'refs/heads/release')]
  isSandbox: $[eq(variables['Build.SourceBranch'], 'refs/heads/sandbox')]
  isFeature: $[startsWith(variables['Build.SourceBranch'], 'refs/heads/feature/')]
  isBugfix: $[startsWith(variables['Build.SourceBranch'], 'refs/heads/bugfix/')]
  isHotfix: $[startsWith(variables['Build.SourceBranch'], 'refs/heads/hotfix/')]
  isPR: $[eq(variables['Build.Reason'], 'PullRequest')]
  
  # Build Configuration
  buildConfiguration: 'Release'

pool:
  vmImage: windows-latest

stages:
  - stage: Validate
    displayName: "ðŸ” PR Validation"
    condition: eq(variables.isPR, true)
    jobs: 
      - job: ValidateBranchRules
        displayName: "Branch Rules Check"
        steps: 
          - checkout: none

          - powershell: |
              $sourceBranch = "$(System.PullRequest.SourceBranch)" -replace "refs/heads/", ""
              $targetBranch = "$(System.PullRequest.TargetBranch)" -replace "refs/heads/", ""
              
              Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              Write-Host "                    PR VALIDATION                              "
              Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              Write-Host ""
              Write-Host "ðŸ“¤ Source Branch: $sourceBranch"
              Write-Host "ðŸ“¥ Target Branch: $targetBranch"
              Write-Host ""
              
              $valid = $false
              $errorMessage = ""
              
              switch ($targetBranch) {
                  "main" {
                      if ($sourceBranch -eq "release" -or $sourceBranch -like "hotfix/*") {
                          $valid = $true
                      } else {
                          $errorMessage = "MAIN BRANCH KURALI IHLALI! Main branch'e sadece release veya hotfix/* merge edilebilir. Sizin kaynak: $sourceBranch"
                      }
                  }
                  "release" {
                      if ($sourceBranch -eq "sandbox" -or $sourceBranch -like "bugfix/*") {
                          $valid = $true
                      } else {
                          $errorMessage = "RELEASE BRANCH KURALI IHLALI! Release branch'e sadece sandbox veya bugfix/* merge edilebilir. Sizin kaynak: $sourceBranch"
                      }
                  }
                  "sandbox" {
                      if ($sourceBranch -like "feature/*") {
                          $valid = $true
                      } else {
                          $errorMessage = "SANDBOX BRANCH KURALI IHLALI! Sandbox branch'e sadece feature/* merge edilebilir. Sizin kaynak: $sourceBranch"
                      }
                  }
                  default {
                      $valid = $true
                  }
              }
              
              if ($valid) {
                  Write-Host "âœ… PR VALIDATION BASARILI: $sourceBranch â†’ $targetBranch"
              } else {
                  Write-Host "##[error]$errorMessage"
                  exit 1
              }
            displayName: "ðŸ” Validate Branch Rules"

  - stage: Build
    displayName: "ðŸ”¨ Build"
    dependsOn: Validate
    condition: or(and(succeeded(), eq(variables.isPR, true)), and(always(), ne(variables.isPR, true)))
    jobs:
      - job: CompileAndPackage
        displayName: "Compile AL Application"
        timeoutInMinutes: 60
        steps: 
          - checkout: self
            clean: true
            fetchDepth: 0

          - task: PowerShell@2
            displayName: "ðŸ“¦ Build & Package"
            inputs: 
              targetType: inline
              script: |
                Write-Host "BUILD STARTED"
                Write-Host "Branch: $(Build.SourceBranch)"
                Write-Host "Build Number: $(Build.BuildNumber)"
                
                if (Test-Path "$(Build.SourcesDirectory)/CompileApp.ps1") {
                    & "$(Build.SourcesDirectory)/CompileApp.ps1"
                } else {
                    New-Item -ItemType Directory -Force -Path "$(Build.StagingDirectory)" | Out-Null
                    @{
                        BuildNumber = "$(Build.BuildNumber)"
                        Branch = "$(Build.SourceBranch)"
                        Commit = "$(Build.SourceVersion)"
                        BuildDate = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                    } | ConvertTo-Json | Out-File "$(Build.StagingDirectory)/build-info.json"
                }

          - publish: $(Build.StagingDirectory)
            artifact: drop
            displayName: "ðŸ“¤ Publish Artifact"

  - stage: DeployToSandbox
    displayName: "ðŸ§ª Deploy to Sandbox"
    dependsOn: Build
    condition: and(succeeded(), ne(variables.isPR, true), or(eq(variables.isSandbox, true), eq(variables.isFeature, true)))
    jobs:
      - deployment: DeploySandboxEnv
        displayName: "Deploy to Sandbox Environment"
        environment: Sandbox
        strategy:
          runOnce:
            deploy:
              steps: 
                - download: current
                  artifact: drop
                - powershell: |
                    Write-Host "ðŸ§ª SANDBOX DEPLOYMENT"
                    Write-Host "Environment: Sandbox"
                    Write-Host "Branch: $(Build.SourceBranch)"
                    Write-Host "âœ… Sandbox deployment basarili!"
                  displayName: "ðŸš€ Deploy to Sandbox"

  - stage: ReleaseStaging
    displayName: "ðŸŽ¯ Release Staging"
    dependsOn: Build
    condition: and(succeeded(), ne(variables.isPR, true), or(eq(variables.isRelease, true), eq(variables.isBugfix, true)))
    jobs:
      - deployment: ReleaseStagingEnv
        displayName: "Deploy to Release Staging"
        environment: Sandbox
        strategy: 
          runOnce:
            deploy: 
              steps: 
                - download: current
                  artifact: drop
                - powershell: |
                    Write-Host "ðŸŽ¯ RELEASE STAGING DEPLOYMENT"
                    Write-Host "Environment: Release Staging"
                    Write-Host "Branch: $(Build.SourceBranch)"
                    Write-Host "âœ… Release staging deployment basarili!"
                  displayName: "ðŸš€ Deploy to Release Staging"

  - stage: DeployToProduction
    displayName: "ðŸŒŸ Deploy to Production"
    dependsOn: Build
    condition: and(succeeded(), ne(variables.isPR, true), or(eq(variables.isMain, true), eq(variables.isHotfix, true)))
    jobs:
      - deployment: DeployProductionEnv
        displayName: "Deploy to Production Environment"
        environment: Production
        strategy: 
          runOnce: 
            deploy: 
              steps:
                - download: current
                  artifact: drop
                - powershell: |
                    Write-Host "ðŸŒŸ PRODUCTION DEPLOYMENT"
                    Write-Host "Environment: Production"
                    Write-Host "Branch: $(Build.SourceBranch)"
                    Write-Host "âœ… Production deployment basarili!"
                  displayName: "ðŸš€ Deploy to Production"

  - stage: BackMergeFromMain
    displayName: "ðŸ”„ Back-Merge (Main)"
    dependsOn: DeployToProduction
    condition: and(succeeded(), eq(variables.isMain, true))
    jobs:
      - job: SyncBranchesFromMain
        displayName: "Sync: Main â†’ Release â†’ Sandbox"
        steps: 
          - checkout: self
            persistCredentials: true
            fetchDepth: 0

          - powershell: |
              Write-Host "ðŸ”„ BACK-MERGE BASLATILIYOR"
              
              git config user.email "devops-bot@pargesoft.com"
              git config user.name "DevOps Bot"
              git fetch origin --prune
              
              # Main â†’ Release
              Write-Host "ðŸ“Œ ADIM 1: Main â†’ Release"
              git checkout release 2>&1
              git pull origin release --no-edit 2>&1
              $mergeOutput = git merge origin/main -m "[skip ci] Auto-merge: Main â†’ Release" --no-edit 2>&1
              
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "##[warning]Conflict detected, aborting merge..."
                  git merge --abort 2>&1
              } else {
                  git push origin release 2>&1
                  Write-Host "âœ… Main â†’ Release basarili!"
              }
              
              # Release â†’ Sandbox
              Write-Host "ðŸ“Œ ADIM 2: Release â†’ Sandbox"
              git checkout sandbox 2>&1
              git pull origin sandbox --no-edit 2>&1
              $mergeOutput = git merge origin/release -m "[skip ci] Auto-merge: Release â†’ Sandbox" --no-edit 2>&1
              
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "##[warning]Conflict detected, aborting merge..."
                  git merge --abort 2>&1
              } else {
                  git push origin sandbox 2>&1
                  Write-Host "âœ… Release â†’ Sandbox basarili!"
              }
              
              Write-Host "âœ… BACK-MERGE TAMAMLANDI"
            displayName: "ðŸ”„ Execute Back-Merge"

  - stage: BackMergeFromHotfix
    displayName: "ðŸ”¥ Hotfix Back-Merge"
    dependsOn: DeployToProduction
    condition: and(succeeded(), eq(variables.isHotfix, true))
    jobs:
      - job: SyncAfterHotfix
        displayName: "Sync After Hotfix"
        steps:
          - checkout: self
            persistCredentials: true
            fetchDepth: 0

          - powershell: |
              Write-Host "ðŸ”¥ HOTFIX BACK-MERGE BASLATILIYOR"
              
              git config user.email "devops-bot@pargesoft.com"
              git config user.name "DevOps Bot"
              git fetch origin --prune
              
              $hotfixBranch = "$(Build.SourceBranch)" -replace "refs/heads/", ""
              
              # Hotfix â†’ Release
              git checkout release 2>&1
              git pull origin release --no-edit 2>&1
              git merge "origin/$hotfixBranch" -m "[skip ci] Hotfix merge: $hotfixBranch â†’ Release" --no-edit 2>&1
              if ($LASTEXITCODE -eq 0) { git push origin release 2>&1 }
              
              # Release â†’ Sandbox
              git checkout sandbox 2>&1
              git pull origin sandbox --no-edit 2>&1
              git merge origin/release -m "[skip ci] Auto-merge: Release â†’ Sandbox" --no-edit 2>&1
              if ($LASTEXITCODE -eq 0) { git push origin sandbox 2>&1 }
              
              Write-Host "âœ… HOTFIX BACK-MERGE TAMAMLANDI"
            displayName: "ðŸ”¥ Execute Hotfix Back-Merge"

  - stage: BackMergeFromBugfix
    displayName: "ðŸ› Bugfix Back-Merge"
    dependsOn: ReleaseStaging
    condition: and(succeeded(), eq(variables.isBugfix, true))
    jobs:
      - job: SyncAfterBugfix
        displayName: "Sync Sandbox After Bugfix"
        steps: 
          - checkout: self
            persistCredentials: true
            fetchDepth: 0

          - powershell: |
              Write-Host "ðŸ› BUGFIX BACK-MERGE BASLATILIYOR"
              
              git config user.email "devops-bot@pargesoft.com"
              git config user.name "DevOps Bot"
              git fetch origin --prune
              
              git checkout sandbox 2>&1
              git pull origin sandbox --no-edit 2>&1
              git merge origin/release -m "[skip ci] Bugfix sync: Release â†’ Sandbox" --no-edit 2>&1
              if ($LASTEXITCODE -eq 0) { git push origin sandbox 2>&1 }
              
              Write-Host "âœ… BUGFIX BACK-MERGE TAMAMLANDI"
            displayName: "ðŸ› Execute Bugfix Back-Merge"

  - stage: Cleanup
    displayName: "ðŸ§¹ Cleanup"
    dependsOn: 
      - BackMergeFromMain
      - BackMergeFromHotfix
      - BackMergeFromBugfix
    condition: and(always(), or(eq(variables.isHotfix, true), eq(variables.isBugfix, true)))
    jobs:
      - job: CleanupBranches
        displayName: "Cleanup Merged Branches"
        steps:
          - checkout: self
            persistCredentials: true
            fetchDepth: 0

          - powershell: |
              Write-Host "ðŸ§¹ BRANCH CLEANUP"
              $sourceBranch = "$(Build.SourceBranch)" -replace "refs/heads/", ""
              
              git config user.email "devops-bot@pargesoft.com"
              git config user.name "DevOps Bot"
              
              git push origin --delete $sourceBranch 2>&1
              
              if ($LASTEXITCODE -eq 0) {
                  Write-Host "âœ… Branch '$sourceBranch' silindi."
              } else {
                  Write-Host "##[warning]Branch silinemedi veya zaten silinmis."
              }
            displayName: "ðŸ§¹ Delete Merged Branch"
