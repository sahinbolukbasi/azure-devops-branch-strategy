# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Business Central CI/CD Pipeline
# Branch Strategy: feature/* â†’ sandbox â†’ release â†’ main
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

trigger:
  branches:
    include: [main, release, sandbox, feature/*, hotfix/*]

pr:
  branches:
    include: [main, release, sandbox]

variables:
  isMain: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  isRelease: $[eq(variables['Build.SourceBranch'], 'refs/heads/release')]
  isSandbox: $[eq(variables['Build.SourceBranch'], 'refs/heads/sandbox')]
  isHotfix: $[startsWith(variables['Build.SourceBranch'], 'refs/heads/hotfix/')]
  isPR: $[eq(variables['Build.Reason'], 'PullRequest')]

pool:
  vmImage: windows-latest

stages:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PR VALIDATION - Branch kurallarÄ±nÄ± kontrol et
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - stage: Validate
    displayName: " Validate PR"
    condition: eq(variables.isPR, true)
    jobs:
      - job: ValidateBranch
        displayName: "Validate Source Branch"
        steps:
          - checkout: none

          - powershell: |
              $sourceBranch = "$(System.PullRequest.SourceBranch)" -replace "refs/heads/", ""
              $targetBranch = "$(System.PullRequest.TargetBranch)" -replace "refs/heads/", ""

              Write-Host "##[section]PR Validation"
              Write-Host "Source: $sourceBranch"
              Write-Host "Target: $targetBranch"
              Write-Host ""

              $valid = $false
              $errorMessage = ""

              switch ($targetBranch) {
                  "main" {
                      if ($sourceBranch -eq "release" -or $sourceBranch -like "hotfix/*") {
                          $valid = $true
                      } else {
                          $errorMessage = @"
               MAIN BRANCH KURALI Ä°HLALÄ°!

              Main branch'e sadece ÅŸu kaynaklardan PR aÃ§Ä±labilir:
                 release
                 hotfix/*

              Sizin kaynak branch'iniz: $sourceBranch

              DoÄŸru akÄ±ÅŸ: feature/* â†’ sandbox â†’ release â†’ main
              "@
                      }
                  }
                  "release" {
                      if ($sourceBranch -eq "sandbox" -or $sourceBranch -like "hotfix/*") {
                          $valid = $true
                      } else {
                          $errorMessage = @"
               RELEASE BRANCH KURALI Ä°HLALÄ°!

              Release branch'e sadece ÅŸu kaynaklardan PR aÃ§Ä±labilir:
                 sandbox
                 hotfix/*
              Sizin kaynak branch'iniz: $sourceBranch

               DoÄŸru akÄ±ÅŸ: feature/* â†’ sandbox â†’ release
              "@
                      }
                  }
                  "sandbox" {
                      if ($sourceBranch -like "feature/*" -or $sourceBranch -like "bugfix/*" -or $sourceBranch -like "improvement/*") {
                          $valid = $true
                      } else {
                          $errorMessage = @"
               SANDBOX BRANCH KURALI Ä°HLALÄ°!

              Sandbox branch'e sadece ÅŸu kaynaklardan PR aÃ§Ä±labilir:
                 feature/*
                 bugfix/*
                 improvement/*

              Sizin kaynak branch'iniz: $sourceBranch
              "@
                      }
                  }
                  default { $valid = $true }
              }

              if ($valid) {
                  Write-Host "##[section]âœ… PR Validation BaÅŸarÄ±lÄ±: $sourceBranch â†’ $targetBranch"
              } else {
                  Write-Host "##[error]$errorMessage"
                  exit 1
              }
            displayName: "ğŸ” Check Branch Rules"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD STAGE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - stage: Build
    displayName: "Build"
    dependsOn: Validate
    condition: or(succeeded(), ne(variables.isPR, true))
    jobs:
      - job: Compile
        displayName: "Compile AL Application"
        timeoutInMinutes: 60
        steps:
          - checkout: self
            clean: true

          - task: PowerShell@2
            displayName: "Build & Package"
            inputs:
              targetType: filePath
              filePath: CompileApp.ps1
              workingDirectory: $(Build.SourcesDirectory)

          - publish: $(Build.StagingDirectory)
            artifact: drop
            displayName: "Publish Artifact"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY STAGES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - stage: DeploySandbox
    displayName: "ğŸ§ª Deploy Sandbox"
    dependsOn: Build
    condition: and(succeeded(), eq(variables.isSandbox, true))
    jobs:
      - deployment: Sandbox
        environment: Development
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                - script: echo "Deployed to Sandbox"

  - stage: DeployRelease
    displayName: " Deploy Release"
    dependsOn: Build
    condition: and(succeeded(), eq(variables.isRelease, true))
    jobs:
      - deployment: Release
        environment: Staging
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                - script: echo "Deployed to Staging"

  - stage: DeployProduction
    displayName: "ğŸŒŸ Deploy Production"
    dependsOn: Build
    condition: and(succeeded(), or(eq(variables.isMain, true), eq(variables.isHotfix, true)))
    jobs:
      - deployment: Production
        environment: Production
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                - script: echo " Deployed to Production"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BACK-MERGE (Main â†’ Release â†’ Sandbox) - WITH CONFLICT HANDLING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - stage: BackMerge
    displayName: "Back-Merge"
    dependsOn: DeployProduction
    condition: and(succeeded(), eq(variables.isMain, true))
    jobs:
      - job: Sync
        displayName: "Sync Branches"
        steps:
          - checkout: self
            persistCredentials: true
            fetchDepth: 0

          - powershell: |
              # Git Kimlik DoÄŸrulama
              git config user.email "sahinbolukbasi@pargesoft.com"
              git config user.name "DevOps Bot"
              git fetch origin

              # -------------------------------------------------------
              # 1. ADIM: Main â†’ Release
              # -------------------------------------------------------
              Write-Host "##[section] Merging Main into Release..."
              git checkout release
              git pull origin release # Uzak sunucudaki son hali al

              # Merge Denemesi
              git merge origin/main -m "[skip ci] Auto-merge: Main â†’ Release" --no-edit

              # Conflict KontrolÃ¼
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "##[error]CONFLICT DETECTED: Main â†’ Release"
                  Write-Host " Otomatik birleÅŸtirme sÄ±rasÄ±nda Ã§akÄ±ÅŸma oluÅŸtu. Ä°ÅŸlem iptal ediliyor."
                  
                  # Merge iÅŸlemini geri al ve temizle
                  git merge --abort
                  
                  Write-Host "##[warning]LÃ¼tfen lokalinizde 'release' branchine geÃ§ip 'git merge main' komutunu manuel Ã§alÄ±ÅŸtÄ±rarak Ã§akÄ±ÅŸmalarÄ± Ã§Ã¶zÃ¼n."
                  exit 1
              }
              
              # BaÅŸarÄ±lÄ±ysa Pushla
              git push origin release
              Write-Host " Main â†’ Release senkronizasyonu baÅŸarÄ±lÄ±."

              # -------------------------------------------------------
              # 2. ADIM: Release â†’ Sandbox
              # -------------------------------------------------------
              Write-Host "##[section] Merging Release into Sandbox..."
              git checkout sandbox
              git pull origin sandbox

              # Merge Denemesi
              git merge origin/release -m "[skip ci] Auto-merge: Release â†’ Sandbox" --no-edit

              # Conflict KontrolÃ¼
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "##[error] CONFLICT DETECTED: Release â†’ Sandbox"
                  Write-Host " Otomatik birleÅŸtirme sÄ±rasÄ±nda Ã§akÄ±ÅŸma oluÅŸtu. Ä°ÅŸlem iptal ediliyor."
                  
                  # Merge iÅŸlemini geri al
                  git merge --abort
                  
                  Write-Host "##[warning]LÃ¼tfen lokalinizde 'sandbox' branchine geÃ§ip 'git merge release' komutunu manuel Ã§alÄ±ÅŸtÄ±rarak Ã§akÄ±ÅŸmalarÄ± Ã§Ã¶zÃ¼n."
                  exit 1
              }

              # BaÅŸarÄ±lÄ±ysa Pushla
              git push origin sandbox
              Write-Host " Release â†’ Sandbox senkronizasyonu baÅŸarÄ±lÄ±."
              
            displayName: " Execute Back-Merge with Conflict Check"